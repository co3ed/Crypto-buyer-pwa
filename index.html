<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crypto Buyer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #10131a;
      color: #f5f5f5;
      margin: 0;
      padding: 1em;
    }
    h1 { text-align: center; }
    .card {
      background: #1e222d;
      padding: 1em;
      margin: 20px auto;
      max-width: 500px;
      border-radius: 8px;
    }
    .button {
      background: #00ccff;
      color: black;
      font-weight: bold;
      cursor: pointer;
      padding: 10px;
      margin-top: 10px;
      display: block;
      width: 100%;
      text-align: center;
      border: none;
      border-radius: 4px;
    }
    .confidence-bar {
      background: #333;
      border-radius: 6px;
      overflow: hidden;
      height: 20px;
      margin-top: 10px;
    }
    .confidence-fill {
      height: 100%;
      text-align: center;
      line-height: 20px;
      font-size: 12px;
      font-weight: bold;
      color: white;
      background-color: green;
      transition: width 0.4s ease-in-out;
    }
    .percentage {
      font-weight: bold;
      display: inline;
      margin-left: 10px;
    }
    .percentage.green { color: green; }
    .percentage.red { color: red; }
    .percentage.gray { color: gray; }
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
    }
    .modal-content {
      background-color: #1e222d;
      color: white;
      margin: 10% auto;
      padding: 1em;
      border: 1px solid #888;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
    }
    .close {
      float: right;
      font-size: 1.4em;
      font-weight: bold;
      cursor: pointer;
      color: #00ccff;
    }
    .dot {
      font-size: 2em;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Crypto Buyer</h1>

  <div class="card">
    <label>Token: </label>
    <input type="text" id="tokenInput" placeholder="Enter token symbol (e.g. BTC, ETH)" />
    <button class="button" onclick="analyse()">Analyse</button>
    <button class="button" onclick="document.getElementById('modal').style.display='block'">Instructions</button>
    <button class="button" onclick="showReasoning()">View Reasoning</button>
  </div>

  <div class="card">
    <label>Buy Price: </label>
    <input type="number" id="buyPriceInput" placeholder="Enter your buy price" />
    <button class="button" onclick="lockBuyPrice()">Lock Buy Price</button>
    <button class="button" onclick="calculateProfitLoss()">Percentage Profit/Loss</button>
    <p id="lockedPriceDisplay" style="color:gray; font-weight:bold;"></p>
    <p id="percentageChange" class="percentage" style="font-weight:bold;"></p>
  </div>

  <div id="result"></div>

  <div class="card">
    <label>Confidence: </label>
    <div class="confidence-bar">
      <div id="confidenceFill" class="confidence-fill">0%</div>
    </div>
    <p id="recommendationText"></p>
  </div>

  <div class="card">
    <label>Recommendation:</label>
    <div id="recommendationDot" class="dot"></div>
  </div>

  <!-- INSTRUCTIONS MODAL -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="document.getElementById('modal').style.display='none'">&times;</span>
      <h2>How to Use Crypto Buyer</h2>
      <p>1. Enter the ticker symbol (e.g. BTC, ETH).</p>
      <p>2. Tap "Analyse" to get real-time data and a Buy, Hold, or Sell recommendation.</p>
      <p>3. Enter your buy price to track gains or losses.</p>
    </div>
  </div>

  <!-- REASONING MODAL -->
  <div id="reasoningModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeReasoning()">&times;</span>
      <h2>Reasoning Behind the Decision</h2>
      <p id="reasoningText">Loading...</p>
    </div>
  </div>

  <script>
    let currentAnalysis = {};
    let buyPrice = null;
    let currentPrice = null;

    function showReasoning() {
      const reasoningText = `RSI: ${currentAnalysis.rsi.toFixed(1)} — ${currentAnalysis.rsi > 70 ? "overbought" : currentAnalysis.rsi < 30 ? "oversold" : "neutral"}.
MACD: ${currentAnalysis.macd.toFixed(2)} — ${currentAnalysis.macd > 0 ? "bullish" : "bearish"}.
24h Change: ${currentAnalysis.priceChange}% — ${currentAnalysis.priceChange > 0 ? "uptrend" : "downtrend"}.`;

      document.getElementById('reasoningText').textContent = reasoningText;
      document.getElementById('reasoningModal').style.display = 'block';
    }

    function closeReasoning() {
      document.getElementById('reasoningModal').style.display = 'none';
    }

    function lockBuyPrice() {
      buyPrice = parseFloat(document.getElementById('buyPriceInput').value);
      if (!buyPrice || buyPrice <= 0) {
        alert('Please enter a valid buy price.');
        return;
      }
      document.getElementById('lockedPriceDisplay').textContent = `Locked Buy Price: $${buyPrice.toFixed(2)}`;
    }

    function calculateProfitLoss() {
      if (buyPrice === null || currentPrice === null) {
        alert("Lock a buy price and run analysis first.");
        return;
      }

      const change = ((currentPrice - buyPrice) / buyPrice) * 100;
      const el = document.getElementById('percentageChange');
      el.textContent = `${change > 0 ? 'Gain' : 'Loss'}: ${change.toFixed(2)}%`;
      el.className = 'percentage ' + (change > 0 ? 'green' : 'red');
    }

    function calculateRSI(closes, period = 14) {
      let gains = 0, losses = 0;
      for (let i = closes.length - period; i < closes.length - 1; i++) {
        const change = closes[i + 1] - closes[i];
        if (change > 0) gains += change;
        else losses -= change;
      }
      if (losses === 0) return 100;
      const rs = gains / losses;
      return 100 - (100 / (1 + rs));
    }

    async function analyse() {
      const token = document.getElementById('tokenInput').value.toUpperCase();
      const symbol = token + "USDT";
      const resultDiv = document.getElementById("result");

      try {
        const candleRes = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1h&limit=100`);
        const tickerRes = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${symbol}`);
        if (!candleRes.ok || !tickerRes.ok) throw new Error("Invalid token");

        const candles = await candleRes.json();
        const ticker = await tickerRes.json();
        const closes = candles.map(c => parseFloat(c[4])); // closing prices
        const price = parseFloat(ticker.lastPrice);
        currentPrice = price;

        const change = parseFloat(ticker.priceChangePercent);
        const volume = parseFloat(ticker.quoteVolume);
        const rsi = calculateRSI(closes);
        const macdHist = closes[closes.length - 1] - closes[closes.length - 13]; // basic MACD approx

        currentAnalysis = { rsi, macd: macdHist, volume, priceChange: change };

        resultDiv.innerHTML = `
          <div class="card" style="border: 2px solid limegreen;">
            <h2>${symbol}</h2>
            <p>Price: $${price.toFixed(6)}</p>
            <p>24h Change: <span style="color:${change > 0 ? 'green' : 'red'}">${change}%</span></p>
            <p>RSI: ${rsi.toFixed(1)}</p>
            <p>MACD Approx: ${macdHist.toFixed(2)}</p>
            <p>Volume: $${(volume / 1_000_000).toFixed(1)}M</p>
          </div>
        `;

        // --- SMART CONFIDENCE SCORING ---
        let score = 50;
        if (rsi < 30) score += 15;
        else if (rsi > 70) score -= 15;

        if (macdHist > 0) score += 15;
        else score -= 15;

        if (change > 0) score += 10;
        else score -= 10;

        const confidence = Math.max(0, Math.min(100, score));

        const fill = document.getElementById('confidenceFill');
        fill.style.width = confidence + '%';
        fill.textContent = confidence + '%';
        fill.style.backgroundColor = confidence >= 70 ? 'green' : confidence >= 50 ? 'orange' : 'red';

        const dot = document.getElementById('recommendationDot');
        dot.textContent = '●';
        dot.style.color = confidence >= 70 ? 'green' : confidence >= 50 ? 'orange' : 'red';

        const recText = document.getElementById('recommendationText');
        recText.textContent = confidence >= 70 ? 'Recommendation: Buy' :
                              confidence >= 50 ? 'Recommendation: Hold' :
                              'Recommendation: Sell';

      } catch (err) {
        resultDiv.innerHTML = `<div class="card"><p>Error: Could not fetch data for <strong>${token}</strong>.</p></div>`;
        console.error(err);
      }
    }
  </script>
</body>
</html>